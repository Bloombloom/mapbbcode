# How to write a forum modification

## Quick start

Writing forum modifications is hard, especially if you haven't done it before, so we'll start with minimum number of steps to display [map] bbcode in threads.

### Include libraries in a page header

First of all, find a place in the forum engine directory tree where you can put all MapBBCode libraries. It shouldn't be a theme directory, so if a forum administrator has a lot of themes, libraries don't get copied into all of them. Preferably it's `scripts` or `includes` directory in the root. Modify paths in javascript code according to your directory structure.

Usually there is a main theme, like `subSilver` or `proSilver` in phpBB. Find a template for a page header in it. There can be more than one ("full" and "simple"). In some cases page header is generated by a script (e.g. in SMF). In any case, you should add the following code right before the `</head>` HTML tag (don't forget to write proper paths):

```html
<link rel="stylesheet" href="includes/mapbbcode/leaflet.css" />
<link rel="stylesheet" href="includes/mapbbcode/leaflet.draw.css" />
<!--[if lte IE 8]>
    <link rel="stylesheet" href="includes/mapbbcode/leaflet.ie.css" />
    <link rel="stylesheet" href="includes/mapbbcode/leaflet.draw.ie.css" />
<![endif]-->
<script src="includes/mapbbcode/leaflet.js"></script>
<script src="includes/mapbbcode/leaflet.draw.js"></script>
<script src="includes/mapbbcode/Bing.js"></script>
<script src="includes/mapbbcode/mapbbcode.js"></script>
<script src="includes/mapbbcode/mapbbcode-config.js"></script>
<script language="Javascript" type="text/javascript">
<!--
var mapBBcode = new MapBBCode({
    libPath: 'includes/mapbbcode/',
    layers: 'OpenStreetMap',
    defaultZoom: 2,
    defaultPosition: [22, 11],
    viewWidth: 600,
    viewHeight: 300,
    fullViewHeight: 600,
    editorHeight: 400,
    windowWidth: 800,
    windowHeight: 500,
    fullFromStart: false,
    preferStandardLayerSwitcher: true
});
//-->
</script>
```

Later this whole block will be conditional, depending on a presence of bbcode tags in a current page.

### Process [map] bbcode

`[map]...[/map]` sequence should be replaced with the following template code:

    <div id="map{DIVID}">{MAPBBCODE}</div>
    <script language="javascript">mapBBcode.show('map{DIVID}');</script>

Here `{MAPBBCODE}` is the entire bbcode, including the enclosing [map] tags (they could contain map zoom and coordinates). `{DIVID}` is a unique identifier of this bbcode. Not a hash of bbcode string, and not a post identifier (imagine two identical maps in a single post). Ideally this is a big random number.

How this template is included depends on a forum engine. For example, in phpBB 2 `{DIVID}` part is pre-generated with the following regular expression:

    $mapre = '#(\[map(?:=[0-9,.-]+)?)(:[a-fA-F0-9]+)?(\].*?\[/map\])#si';
    $text = preg_replace_callback($mapre, create_function('$m','return $m[1].":".make_bbcode_uid().$m[3];'), $text);

And then grouping quotes are parsed into `{DIVID}` (#2) and `{MAPBBCODE}` (#1+#3).

### Add button to a posting page

On a posting page there is usually a row of buttons for inserting bbcode. Add a "Map" button there, with the following code in `onclick` parameter:

    javascript:true ? mapBBcode.editorWindow(document.post.message)
                    : mapBBcode.editor('mapedit', document.post.message);

It unconditionally opens an editor window â€” for now. Later `true` will be replaced with a configuration parameter, so an administrator can choose where does the editor appear. For a inline panel option, you have to add the following tag somewhere inside a posting form, before bbcode buttons.

   <div id="mapedit"></div>

These three steps are enough to enable [map] bbcode on a forum. Test it by writing some posts with maps. If you found issues in the library code while testing (not in your modification), please report them to [MapBBCode github](https://github.com/MapBBCode/mapbbcode/issues).

## Improvements

For a production-grade forum modification, changes above are not enough. There is no locatization, no configuration panel, and several hundred kilobytes of javascript and css are included in every page, even in the forum index.

### Localization

If possible, it would be best to keep MapBBCode translation strings in a separate file. Those are used in header templates (remember there can be more than one), right after `mapBBcode` object initialization:

```javascript
mapBBcode.setStrings({
    close: '{L_MAPBB_CLOSE}',
    remove: '{L_MAPBB_REMOVE}',
    apply: '{L_MAPBB_APPLY}',
    cancel: '{L_MAPBB_CANCEL}',
    // ...
    helpContents: [{L_MAPBB_HELPCONTENTS}]
});
```

Here `{L_WHATEVER}` are template variables that contain translated strings. Some engines would require to initialize these variables somewhere in code. Don't forget to screen `'` and `\` characters.

The last property, `helpContents`, is an array of strings. It looks like `['line1', 'line2', ..., 'final line']`. It's up to you how this property is defined in a language file (preferably also as an array) and assigned to a template variable.

### Configuration

Administrators should be able to configure the look of the map. There is 11 constructor options plus `editorWindow` mentioned above. They are better put into a main configuration table (e.g. `phpbb_config` for phpBB), since their names and number is constant, and all values are strings. Also this way you won't have to alter the database structure. All options should be prefixed with `mapbb_` to not clash with other parameters.

All constructor options should be read in a page header. Most likely they already are, if you decided to keep them in the main configuration table. The library constructor options would be changed to:

    layers: '{LAYERS}'.split(','),
    defaultZoom: {DEFAULT_ZOOM}+0,
    defaultPosition: [{DEFAULT_POS}],
    viewWidth: {VIEW_WIDTH}+0,
    viewHeight: {VIEW_HEIGHT}+0,
    fullViewHeight: {FULL_HEIGHT}+0,
    editorHeight: {EDITOR_HEIGHT}+0,
    windowWidth: {WINDOW_WIDTH}+0,
    windowHeight: {WINDOW_HEIGHT}+0,
    fullFromStart: {ALWAYS_FULL},
    preferStandardLayerSwitcher: {STANDARD_SWITCHER}

The last two properties are boolean, so you should either cast them to `true`/`false` in the initialization code, or use longer expressions:

    property: '{PROPERTY)' === 'true' || '{PROPERTY}' === '1'

Finally, `editorWindow` parameter goes into a page with a posting form, replacing the `true` constant. It is also boolean, so you may want to use the expression above.

To initialize those options, you will need to execute a number of `INSERT` statements. Consult with the developer's guide for your forum engine on where to put them. Good default values are included at the top of this document.

### Administration panel

*text below is todo*

### Libraries only when needed

```php
$mapbbcode_present = FALSE;
for($i = 0; $i < $total_posts; $i++)
{
    if (preg_match('/\[map(?:=[0-9.,-]+)?\].*?\[\/map\]/', $postrow[$i]['post_text'])) {
        $mapbbcode_present = TRUE;
        break;
    }
}
```

### Private messages

## Checklist

After the modification is complete, install a clean forum instance and apply your modification to it. After it install without errors, check the following use cases.

